<!DOCTYPE html>
<html lang="en-us" dir="ltr">
  <head>
  <meta charset="utf-8" />
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  <title>Jenkins&#43;Github&#43;Gradle&#43;Android &middot; 你好，世界</title>
  <meta name="description" content="" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/normalize/8.0.1/normalize.min.css" />
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.10.0/dist/katex.min.css" integrity="sha384-9eLZqc9ds8eNjO3TmqPeYcDj8n+Qfa4nuSiGYa6DjLNcv9BtN69ZIulL9+8CqC9Y" crossorigin="anonymous">
  
  
  
  
  
  <link href="/css/concated.min.css" rel="stylesheet">
  
  
</head>

  <body class="single-body">
    <nav class="nav-bar side-padding">
  <h1 class="nav-header"><a href="/" class="nav-text">你好，世界</a></h1>
  <div class="hamburger-menu">
    <button onclick="hamburgerMenuPressed.call(this)" aria-haspopup="true" aria-expanded="false" aria-controls="menu" aria-label="Menu">
      <span></span>
      <span></span>
    </button>
    <ul id="menu" class="hamburger-menu-overlay">
      <li><a href="/" class="hamburger-menu-overlay-link">Home</a></li>
      
      <li><a href="/categories/12306/" class="hamburger-menu-overlay-link">12306</a></li>
      
      <li><a href="/categories/android/" class="hamburger-menu-overlay-link">Android</a></li>
      
      <li><a href="/categories/android-studio/" class="hamburger-menu-overlay-link">android studio</a></li>
      
      <li><a href="/categories/apk-expansion/" class="hamburger-menu-overlay-link">APK Expansion</a></li>
      
      <li><a href="/categories/bash/" class="hamburger-menu-overlay-link">bash</a></li>
      
      <li><a href="/categories/bitcoin/" class="hamburger-menu-overlay-link">bitcoin</a></li>
      
      <li><a href="/categories/bitlocker/" class="hamburger-menu-overlay-link">bitlocker</a></li>
      
      <li><a href="/categories/btc/" class="hamburger-menu-overlay-link">btc</a></li>
      
      <li><a href="/categories/byte-alignment/" class="hamburger-menu-overlay-link">Byte alignment</a></li>
      
      <li><a href="/categories/c/" class="hamburger-menu-overlay-link">C</a></li>
      
      <li><a href="/categories/camera/" class="hamburger-menu-overlay-link">Camera</a></li>
      
      <li><a href="/categories/charset/" class="hamburger-menu-overlay-link">charset</a></li>
      
      <li><a href="/categories/chrome/" class="hamburger-menu-overlay-link">chrome</a></li>
      
      <li><a href="/categories/classnotfound/" class="hamburger-menu-overlay-link">ClassNotFound</a></li>
      
      <li><a href="/categories/d/" class="hamburger-menu-overlay-link">d</a></li>
      
      <li><a href="/categories/ddos/" class="hamburger-menu-overlay-link">ddos</a></li>
      
      <li><a href="/categories/ebola/" class="hamburger-menu-overlay-link">Ebola</a></li>
      
      <li><a href="/categories/ec2/" class="hamburger-menu-overlay-link">EC2</a></li>
      
      <li><a href="/categories/eva/" class="hamburger-menu-overlay-link">EVA</a></li>
      
      <li><a href="/categories/ffmpeg/" class="hamburger-menu-overlay-link">ffmpeg</a></li>
      
      <li><a href="/categories/fonts.googleapis.com/" class="hamburger-menu-overlay-link">fonts.googleapis.com</a></li>
      
      <li><a href="/categories/forget-password/" class="hamburger-menu-overlay-link">forget password</a></li>
      
      <li><a href="/categories/gallery/" class="hamburger-menu-overlay-link">Gallery</a></li>
      
      <li><a href="/categories/ghost/" class="hamburger-menu-overlay-link">ghost</a></li>
      
      <li><a href="/categories/git/" class="hamburger-menu-overlay-link">git</a></li>
      
      <li><a href="/categories/gpl/" class="hamburger-menu-overlay-link">gpl</a></li>
      
      <li><a href="/categories/gradle/" class="hamburger-menu-overlay-link">Gradle</a></li>
      
      <li><a href="/categories/gta/" class="hamburger-menu-overlay-link">GTA</a></li>
      
      <li><a href="/categories/hal/" class="hamburger-menu-overlay-link">HAL</a></li>
      
      <li><a href="/categories/hardware-requirement/" class="hamburger-menu-overlay-link">hardware requirement</a></li>
      
      <li><a href="/categories/hexo&#43;/" class="hamburger-menu-overlay-link">Hexo&#43;</a></li>
      
      <li><a href="/categories/highlight-syntax/" class="hamburger-menu-overlay-link">highlight syntax</a></li>
      
      <li><a href="/categories/imagefetcher/" class="hamburger-menu-overlay-link">ImageFetcher</a></li>
      
      <li><a href="/categories/internet/" class="hamburger-menu-overlay-link">Internet</a></li>
      
      <li><a href="/categories/jenkins/" class="hamburger-menu-overlay-link">Jenkins</a></li>
      
      <li><a href="/categories/kickstarter/" class="hamburger-menu-overlay-link">kickstarter</a></li>
      
      <li><a href="/categories/limits/" class="hamburger-menu-overlay-link">limits</a></li>
      
      <li><a href="/categories/link/" class="hamburger-menu-overlay-link">link</a></li>
      
      <li><a href="/categories/linux/" class="hamburger-menu-overlay-link">linux</a></li>
      
      <li><a href="/categories/load-library/" class="hamburger-menu-overlay-link">load library</a></li>
      
      <li><a href="/categories/logo/" class="hamburger-menu-overlay-link">logo</a></li>
      
      <li><a href="/categories/ltc/" class="hamburger-menu-overlay-link">ltc</a></li>
      
      <li><a href="/categories/monkeyrunner/" class="hamburger-menu-overlay-link">monkeyrunner</a></li>
      
      <li><a href="/categories/multi-path/" class="hamburger-menu-overlay-link">multi-path</a></li>
      
      <li><a href="/categories/nerv/" class="hamburger-menu-overlay-link">NERV</a></li>
      
      <li><a href="/categories/node.js/" class="hamburger-menu-overlay-link">node.js</a></li>
      
      <li><a href="/categories/okcoin/" class="hamburger-menu-overlay-link">okcoin</a></li>
      
      <li><a href="/categories/os/" class="hamburger-menu-overlay-link">OS</a></li>
      
      <li><a href="/categories/out-of-memory/" class="hamburger-menu-overlay-link">out of memory</a></li>
      
      <li><a href="/categories/performance/" class="hamburger-menu-overlay-link">performance</a></li>
      
      <li><a href="/categories/proguard/" class="hamburger-menu-overlay-link">proguard</a></li>
      
      <li><a href="/categories/putty/" class="hamburger-menu-overlay-link">putty</a></li>
      
      <li><a href="/categories/python/" class="hamburger-menu-overlay-link">python</a></li>
      
      <li><a href="/categories/qq/" class="hamburger-menu-overlay-link">QQ</a></li>
      
      <li><a href="/categories/relativelayout/" class="hamburger-menu-overlay-link">RelativeLayout</a></li>
      
      <li><a href="/categories/script/" class="hamburger-menu-overlay-link">script</a></li>
      
      <li><a href="/categories/selinux/" class="hamburger-menu-overlay-link">Selinux</a></li>
      
      <li><a href="/categories/sensor/" class="hamburger-menu-overlay-link">sensor</a></li>
      
      <li><a href="/categories/sepolicy/" class="hamburger-menu-overlay-link">Sepolicy</a></li>
      
      <li><a href="/categories/shellshock/" class="hamburger-menu-overlay-link">Shellshock</a></li>
      
      <li><a href="/categories/sparsearray/" class="hamburger-menu-overlay-link">SparseArray</a></li>
      
      <li><a href="/categories/sync/" class="hamburger-menu-overlay-link">sync</a></li>
      
      <li><a href="/categories/ted/" class="hamburger-menu-overlay-link">TED</a></li>
      
      <li><a href="/categories/tips/" class="hamburger-menu-overlay-link">tips</a></li>
      
      <li><a href="/categories/ubuntu/" class="hamburger-menu-overlay-link">Ubuntu</a></li>
      
      <li><a href="/categories/understanding-node.js/" class="hamburger-menu-overlay-link">Understanding node.js</a></li>
      
      <li><a href="/categories/undo/" class="hamburger-menu-overlay-link">undo</a></li>
      
      <li><a href="/categories/upgrade/" class="hamburger-menu-overlay-link">upgrade</a></li>
      
      <li><a href="/categories/view/" class="hamburger-menu-overlay-link">View</a></li>
      
      <li><a href="/categories/windows/" class="hamburger-menu-overlay-link">windows</a></li>
      
      <li><a href="/categories/wordpress/" class="hamburger-menu-overlay-link">wordpress</a></li>
      
      <li><a href="/categories/zsh/" class="hamburger-menu-overlay-link">zsh</a></li>
      
      
    </ul>
  </div>
</nav>

    <main class="content side-text-padding">
      <article class="post dropcase">
        <header class="post-header">
        	<h1 class="post-title">Jenkins&#43;Github&#43;Gradle&#43;Android</h1>
          <p class="post-date">Posted <time datetime="2015-01-15">Jan 15, 2015</time></p>
        </header>
        
        <p>也许题目换成《配置以Github作为源码仓库并用Gradle编译Android的Jenkins时遇到的坑》更恰当~ LOL~</p>

<p>网上<a href="https://www.digitalocean.com/community/tutorials/how-to-build-android-apps-with-jenkins">教学贴</a>很多，不一一列举了。也可以参考<a href="http://nobodycare.me/2014/09/19/jenkins-android-auto-build-problems/">前一篇</a>（BTW，我想说<a href="http://wiki.hudson-ci.org/display/HUDSON/Subversion+Release+Manager">Subversion Release Plugin</a>比自带的Subversion Plugin好用多了）。本文主要补充配置Github和Gradle容易遇到的问题。</p>

<p>重要的plugin：</p>

<ol>
<li><p><a href="https://wiki.jenkins-ci.org/display/JENKINS/Git+Plugin">Git plugin</a></p></li>

<li><p><a href="http://wiki.jenkins-ci.org/display/JENKINS/Gradle+Plugin">Gradle plugin</a></p></li>
</ol>

<p>至于Github plugin之类的插件，自己看着办吧。</p>

<p>这里有几个容易出问题的地方</p>

<ul>
<li>如何用Jenkins从Github获取代码：</li>
</ul>

<p>建议使用<a href="https://developer.github.com/guides/managing-deploy-keys/">Deploy keys</a></p>

<p>怎么用那？最好用<code>.ssh/config</code>，可以参考<a href="http://stackoverflow.com/questions/5212304/authenticate-jenkins-ci-for-github-private-repository">这里</a>。</p>

<p>需要注意的是，在创建ssh key的时候，需要</p>

<pre><code class="language-language-bash">sudo -u jenkins ssh-keygen -t rsa -f .../jenkins/.ssh/id_rsa_project
</code></pre>

<p>加<code>-u</code>来指定以jenkins身份创建key，加<code>-f</code>就是为了方便多个ssh key（例如多repository）的时候好管理。</p>

<p>同时，创建出来的ssh key不要设置密码，因为jenkins对ssh key密码的支持不是特别好，会报public key permission错误（非访问权限问题）。BTW，虽然github提到deploy keys缺点时有说，这货一般为了方便不加密码；但通过command方式，用带密码的ssh key去访问github是没问题的。</p>

<p>当然Github还提供了一套更华丽的方式，叫<a href="https://developer.github.com/guides/managing-deploy-keys/#machine-users">Machine user</a>，简单说就是单独申请一个账户（类似一个代理），把这个账户加到不同的repository里面作为只读的collaborator，再直接在这个账户里面加ssh key（而不用每个repository一个deploy key了），这样通过这一个machine user（代理）就可以访问多个repository了。</p>

<p>最后，这里去clone/pull代码的时候，有时候出报timeout的错误，解决方法有两种，一种是在该目录下，手动git clone &ndash;bare一个repository出来；再一种就是增加timeout时间：<code>源码管理</code> -&gt; <code>Git</code> -&gt; <code>Additional Behaviours</code> -&gt; <code>Advanced clone behaviours</code></p>

<ul>
<li>如何用Jenkins来run Gradle：</li>
</ul>

<p>需要手动匹配gradle版本。在<code>系统设置</code>里面<code>新增Gradle安装</code>即可，不然在<code>Invoke Gradle script</code>的时候，除了<code>default</code>就没得选了。</p>

<p><code>JAVA_HOME</code>和<code>ANDROID_HOME</code>这两个环境变量需要提前设置好（可以在<code>/etc/profile</code>里面export，然后<code>source /etc/profile</code>即可）；修改环境变量后需要重启jenkins；同时注意对应的目录，jenkins是否有访问权限；</p>

<ul>
<li><a href="http://tools.android.com/tech-docs/new-build-system/user-guide#TOC-Signing-Configurations">gradle增加签名</a>用的key的方式如下：
<br /></li>
</ul>

<p>增加<code>signingConfigs</code>，注意路径：</p>

<pre><code class="language-language-groovy">android {
  signingConfigs {
    releaseSignConfig {
    storeFile file(&quot;../../../xxx/android.key&quot;)
    storePassword &quot;xxx&quot;
    keyAlias &quot;xxx&quot;
    keyPassword &quot;xxx&quot;
  }
}

buildTypes {
  debug {
    minifyEnabled false
    signingConfig signingConfigs.releaseSignConfig
  } 
  ...
}
</code></pre>

<p>如果不希望把key/password直接写在gradle中（太直接了好么）；可以换个方式（对，就是通过环境变量）：</p>

<pre><code class="language-language-groovy">signingConfigs {
  release {
    storeFile file(System.getenv(&quot;KEYSTORE&quot;))
    storePassword System.getenv(&quot;KEYSTORE_PASSWORD&quot;)
    keyAlias System.getenv(&quot;KEY_ALIAS&quot;)
    keyPassword System.getenv(&quot;KEY_PASSWORD&quot;)
  }
}
</code></pre>

<ul>
<li><a href="http://tools.android.com/tech-docs/new-build-system/user-guide#TOC-Running-ProGuard">gradle增加proguard</a></li>
</ul>

<p>之前版本是用<code>runProguard true</code>来作为proguard的开关，
但是，自从android gradle plugin升到<a href="http://tools.android.com/tech-docs/new-build-system/migrating-to-1-0-0">1.0</a>以后，就要换成<code>minifyEnabled true</code>了。如：</p>

<pre><code class="language-language-bash">android {
  buildTypes {
    release {
      minifyEnabled true
      proguardFile getDefaultProguardFile('proguard-android.txt')， 'proguard-rules.txt'
    }
  }
}
</code></pre>

<ul>
<li>仅编译release版本</li>
</ul>

<p>Build Task填：</p>

<pre><code class="language-language-bash">clean check assembleRelease
</code></pre>

<p><a href="http://tools.android.com/tech-docs/new-build-system/user-guide#TOC-Android-tasks">因为</a>：</p>

<pre><code class="language-language-bash">build = check + assemble
assemble = assembleRelease + assembleDebug
</code></pre>

<p>如果对于proguard的结果有疑问的话，可以祭出<code>dex2jar</code>反编译看看效果。</p>

<hr />

<p>基本上就这些了。</p>

<p>现在就差。。一个能正常运行Jenkins又价格可接受的Server了。。。</p>

      </article>
      
    </main>
    <nav class="end-nav side-padding">
      
      <a ontouchstart="cardPressed.call(this)" ontouchend="cardReleased.call(this)" ontouchmove="cardReleased.call(this)" 
  href="/posts/android-sparsearray-indexofvalue-return-negative-1/" class="card blog-card" rel="bookmark" >
  
  <article class="card-body">
    <h2 class="card-title">Android SparseArray中indexOfValue返回-1</h2>
    <p class="card-text"></p>
    <div class="card-subtext muted-text">
      <p>Posted <time datetime="2015-01-13 113:00">Jan 13, 2015</time></p>
      <p>#Android #技术 #SparseArray </p>
    </div>
  </article>
</a>
      
      <a ontouchstart="cardPressed.call(this)" ontouchend="cardReleased.call(this)" ontouchmove="cardReleased.call(this)" 
  href="/" class="card home-card" style="background-image: url( /img/grey-cloud.jpg )" rel="bookmark" >
  Home
</a>
    </nav>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.13.1/highlight.min.js"></script>
<script defer src="https://cdn.jsdelivr.net/npm/katex@0.10.0/dist/katex.min.js" integrity="sha384-K3vbOmF2BtaVai+Qk37uypf7VrgBubhQreNQe9aGsz9lB63dIFiQVlJbr92dw2Lx" crossorigin="anonymous"></script>
<script defer src="https://cdn.jsdelivr.net/npm/katex@0.10.0/dist/contrib/auto-render.min.js" integrity="sha384-kmZOZB5ObwgQnS/DuDg6TScgOiWWBiVt0plIRkZCmE6rDZGrEOQeHM5PcHi+nyqe" crossorigin="anonymous"
    onload="renderMathInElement(document.body);"></script>
  
  <script src="/js/core.min.js"></script>
<script>
  hljs.initHighlightingOnLoad();
</script>

  </body>
</html>