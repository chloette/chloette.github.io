<!DOCTYPE html>
<html lang="en-us" dir="ltr">
  <head>
  <meta charset="utf-8" />
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  <title>关于FFmpeg（进阶） &middot; 你好，世界</title>
  <meta name="description" content="" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/normalize/8.0.1/normalize.min.css" />
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.10.0/dist/katex.min.css" integrity="sha384-9eLZqc9ds8eNjO3TmqPeYcDj8n+Qfa4nuSiGYa6DjLNcv9BtN69ZIulL9+8CqC9Y" crossorigin="anonymous">
  
  
  
  
  
  <link href="/css/concated.min.css" rel="stylesheet">
  
  
</head>

  <body class="single-body">
    <nav class="nav-bar side-padding">
  <h1 class="nav-header"><a href="/" class="nav-text">你好，世界</a></h1>
  <div class="hamburger-menu">
    <button onclick="hamburgerMenuPressed.call(this)" aria-haspopup="true" aria-expanded="false" aria-controls="menu" aria-label="Menu">
      <span></span>
      <span></span>
    </button>
    <ul id="menu" class="hamburger-menu-overlay">
      <li><a href="/" class="hamburger-menu-overlay-link">Home</a></li>
      
      <li><a href="/categories/12306/" class="hamburger-menu-overlay-link">12306</a></li>
      
      <li><a href="/categories/android/" class="hamburger-menu-overlay-link">Android</a></li>
      
      <li><a href="/categories/android-studio/" class="hamburger-menu-overlay-link">android studio</a></li>
      
      <li><a href="/categories/apk-expansion/" class="hamburger-menu-overlay-link">APK Expansion</a></li>
      
      <li><a href="/categories/bash/" class="hamburger-menu-overlay-link">bash</a></li>
      
      <li><a href="/categories/bitcoin/" class="hamburger-menu-overlay-link">bitcoin</a></li>
      
      <li><a href="/categories/bitlocker/" class="hamburger-menu-overlay-link">bitlocker</a></li>
      
      <li><a href="/categories/btc/" class="hamburger-menu-overlay-link">btc</a></li>
      
      <li><a href="/categories/byte-alignment/" class="hamburger-menu-overlay-link">Byte alignment</a></li>
      
      <li><a href="/categories/c/" class="hamburger-menu-overlay-link">C</a></li>
      
      <li><a href="/categories/camera/" class="hamburger-menu-overlay-link">Camera</a></li>
      
      <li><a href="/categories/charset/" class="hamburger-menu-overlay-link">charset</a></li>
      
      <li><a href="/categories/chrome/" class="hamburger-menu-overlay-link">chrome</a></li>
      
      <li><a href="/categories/classnotfound/" class="hamburger-menu-overlay-link">ClassNotFound</a></li>
      
      <li><a href="/categories/d/" class="hamburger-menu-overlay-link">d</a></li>
      
      <li><a href="/categories/ddos/" class="hamburger-menu-overlay-link">ddos</a></li>
      
      <li><a href="/categories/ebola/" class="hamburger-menu-overlay-link">Ebola</a></li>
      
      <li><a href="/categories/ec2/" class="hamburger-menu-overlay-link">EC2</a></li>
      
      <li><a href="/categories/eva/" class="hamburger-menu-overlay-link">EVA</a></li>
      
      <li><a href="/categories/ffmpeg/" class="hamburger-menu-overlay-link">ffmpeg</a></li>
      
      <li><a href="/categories/fonts.googleapis.com/" class="hamburger-menu-overlay-link">fonts.googleapis.com</a></li>
      
      <li><a href="/categories/forget-password/" class="hamburger-menu-overlay-link">forget password</a></li>
      
      <li><a href="/categories/gallery/" class="hamburger-menu-overlay-link">Gallery</a></li>
      
      <li><a href="/categories/ghost/" class="hamburger-menu-overlay-link">ghost</a></li>
      
      <li><a href="/categories/git/" class="hamburger-menu-overlay-link">git</a></li>
      
      <li><a href="/categories/gpl/" class="hamburger-menu-overlay-link">gpl</a></li>
      
      <li><a href="/categories/gradle/" class="hamburger-menu-overlay-link">Gradle</a></li>
      
      <li><a href="/categories/gta/" class="hamburger-menu-overlay-link">GTA</a></li>
      
      <li><a href="/categories/hal/" class="hamburger-menu-overlay-link">HAL</a></li>
      
      <li><a href="/categories/hardware-requirement/" class="hamburger-menu-overlay-link">hardware requirement</a></li>
      
      <li><a href="/categories/hexo&#43;/" class="hamburger-menu-overlay-link">Hexo&#43;</a></li>
      
      <li><a href="/categories/highlight-syntax/" class="hamburger-menu-overlay-link">highlight syntax</a></li>
      
      <li><a href="/categories/imagefetcher/" class="hamburger-menu-overlay-link">ImageFetcher</a></li>
      
      <li><a href="/categories/internet/" class="hamburger-menu-overlay-link">Internet</a></li>
      
      <li><a href="/categories/jenkins/" class="hamburger-menu-overlay-link">Jenkins</a></li>
      
      <li><a href="/categories/kickstarter/" class="hamburger-menu-overlay-link">kickstarter</a></li>
      
      <li><a href="/categories/limits/" class="hamburger-menu-overlay-link">limits</a></li>
      
      <li><a href="/categories/link/" class="hamburger-menu-overlay-link">link</a></li>
      
      <li><a href="/categories/linux/" class="hamburger-menu-overlay-link">linux</a></li>
      
      <li><a href="/categories/load-library/" class="hamburger-menu-overlay-link">load library</a></li>
      
      <li><a href="/categories/logo/" class="hamburger-menu-overlay-link">logo</a></li>
      
      <li><a href="/categories/ltc/" class="hamburger-menu-overlay-link">ltc</a></li>
      
      <li><a href="/categories/monkeyrunner/" class="hamburger-menu-overlay-link">monkeyrunner</a></li>
      
      <li><a href="/categories/multi-path/" class="hamburger-menu-overlay-link">multi-path</a></li>
      
      <li><a href="/categories/nerv/" class="hamburger-menu-overlay-link">NERV</a></li>
      
      <li><a href="/categories/node.js/" class="hamburger-menu-overlay-link">node.js</a></li>
      
      <li><a href="/categories/okcoin/" class="hamburger-menu-overlay-link">okcoin</a></li>
      
      <li><a href="/categories/os/" class="hamburger-menu-overlay-link">OS</a></li>
      
      <li><a href="/categories/out-of-memory/" class="hamburger-menu-overlay-link">out of memory</a></li>
      
      <li><a href="/categories/performance/" class="hamburger-menu-overlay-link">performance</a></li>
      
      <li><a href="/categories/proguard/" class="hamburger-menu-overlay-link">proguard</a></li>
      
      <li><a href="/categories/putty/" class="hamburger-menu-overlay-link">putty</a></li>
      
      <li><a href="/categories/python/" class="hamburger-menu-overlay-link">python</a></li>
      
      <li><a href="/categories/qq/" class="hamburger-menu-overlay-link">QQ</a></li>
      
      <li><a href="/categories/relativelayout/" class="hamburger-menu-overlay-link">RelativeLayout</a></li>
      
      <li><a href="/categories/script/" class="hamburger-menu-overlay-link">script</a></li>
      
      <li><a href="/categories/selinux/" class="hamburger-menu-overlay-link">Selinux</a></li>
      
      <li><a href="/categories/sensor/" class="hamburger-menu-overlay-link">sensor</a></li>
      
      <li><a href="/categories/sepolicy/" class="hamburger-menu-overlay-link">Sepolicy</a></li>
      
      <li><a href="/categories/shellshock/" class="hamburger-menu-overlay-link">Shellshock</a></li>
      
      <li><a href="/categories/sparsearray/" class="hamburger-menu-overlay-link">SparseArray</a></li>
      
      <li><a href="/categories/sync/" class="hamburger-menu-overlay-link">sync</a></li>
      
      <li><a href="/categories/ted/" class="hamburger-menu-overlay-link">TED</a></li>
      
      <li><a href="/categories/tips/" class="hamburger-menu-overlay-link">tips</a></li>
      
      <li><a href="/categories/ubuntu/" class="hamburger-menu-overlay-link">Ubuntu</a></li>
      
      <li><a href="/categories/understanding-node.js/" class="hamburger-menu-overlay-link">Understanding node.js</a></li>
      
      <li><a href="/categories/undo/" class="hamburger-menu-overlay-link">undo</a></li>
      
      <li><a href="/categories/upgrade/" class="hamburger-menu-overlay-link">upgrade</a></li>
      
      <li><a href="/categories/view/" class="hamburger-menu-overlay-link">View</a></li>
      
      <li><a href="/categories/windows/" class="hamburger-menu-overlay-link">windows</a></li>
      
      <li><a href="/categories/wordpress/" class="hamburger-menu-overlay-link">wordpress</a></li>
      
      <li><a href="/categories/zsh/" class="hamburger-menu-overlay-link">zsh</a></li>
      
      
    </ul>
  </div>
</nav>

    <main class="content side-text-padding">
      <article class="post dropcase">
        <header class="post-header">
        	<h1 class="post-title">关于FFmpeg（进阶）</h1>
          <p class="post-date">Posted <time datetime="2014-12-24">Dec 24, 2014</time></p>
        </header>
        
        <p>基本篇<a href="http://nobodycare.me/2014/09/29/about-ffmpeg-basic/">在此</a>。</p>
<p>目前仅使用到了ffmpeg的读写文件/编解码功能，并未使用其去直接渲染。</p>
<p>这里说是进阶，其实也只能算浮于表面。因此主要记录使用ffmpeg以来遇到的坑，版本差异，android版本编译等。So，这里就不继续采用Q&amp;A的方式了。</p>
<p>（本文并非通过ffmpeg.exe\bin传递command来进行处理，而是直接调用ffmpeg相关libraries中的api）</p>
<p>####FFmpeg libraries
FFmpeg有以下库：（2014/12/24 ffmpeg 2.5.2），主要功能列在<a href="http://ffmpeg.org/about.html">About</a>中有基本介绍，这里不再赘述。</p>
<ul>
<li>libavutil      54. 15.100</li>
<li>libavcodec     56. 13.100</li>
<li>libavformat    56. 15.102</li>
<li>libavdevice    56.  3.100 &mdash; 未使用</li>
<li>libavfilter     5.  2.103 &mdash; 未使用</li>
<li>libavresample   2.  1.  0 &mdash; 未使用</li>
<li>libswscale      3.  1.101</li>
<li>libswresample   1.  1.100</li>
<li>libpostproc    53.  3.100 &mdash; 未使用</li>
</ul>
<p>####FFmpeg基本
首先，官方文档为第一参考文档；其次就是源码（这里把<em>源码</em>放到这么靠前的原因下文会提到）。</p>
<p>FFmpeg的<a href="http://ffmpeg.org/doxygen/">官方文档</a>算是比较全的。
一些常见case的testbed都可以找得到；例如2.5版本，编解码的<a href="http://ffmpeg.org/doxygen/2.5/decoding_encoding_8c-example.html">sample</a></p>
<p>同时官方的例子并非浅显易懂，但是因为层次简单，所以调用逻辑很清楚；参考着这些文档/Sample就可以按需设计一个简化版Adapter了。</p>
<p>####FFmpeg基本调用逻辑
还记得Decode/Encode和Muxer/Demuxer吧，如果还记得那就很好理解了。下面截选了部分代码（不要在意细节），有一些重要关键但非流程相关的步骤这里先省略（例如FIFO等），下文再提。</p>
<hr>
<p>#####Encoding（Based on 2.x）</p>
<ul>
<li><strong>Register all codec</strong> //应该是plugin的机制</li>
</ul>
<pre><code class="language-language-cpp" data-lang="language-cpp">av_register_all();
avcodec_register_all();
</code></pre><ul>
<li><strong>Find encoder -&gt; create stream -&gt; open encoder</strong></li>
</ul>
<pre><code class="language-language-cpp" data-lang="language-cpp">/* find the audio encoder */
p_audio_codec = avcodec_find_encoder(m_p_fmt_ctx-&gt;oformat-&gt;audio_codec);
if (!p_audio_codec) {
  res = ErrorNoEncoderFound;
  goto EXIT;
}

// Try create stream.
m_p_audio_stream = avformat_new_stream(m_p_fmt_ctx, p_audio_codec);
if (!m_p_audio_stream) {
  LOGE(&quot;Cannot add new audio stream\n&quot;);
  res = ErrorNoStreamFound;
  goto EXIT;
}

p_codec_ctx = m_p_audio_stream-&gt;codec;
... //some regular configurations on encoder

// open the codec.
res = avcodec_open2(p_codec_ctx, p_audio_codec, &amp;p_options);
CHK_RES(res);
</code></pre><ul>
<li><strong>Open File -&gt; write header</strong></li>
</ul>
<pre><code class="language-language-c" data-lang="language-c">res = avio_open(&amp;m_p_fmt_ctx-&gt;pb, m_p_file_path, AVIO_FLAG_WRITE);
...
res = avformat_write_header(m_p_fmt_ctx, NULL);
...
</code></pre><ul>
<li><strong>Encode</strong></li>
</ul>
<pre><code class="language-language-cpp" data-lang="language-cpp">av_init_packet(&amp;output_packet);
 ...
res = avcodec_encode_audio2(output_audio_stream-&gt;codec, &amp;output_packet, frame, data_present);
...
res = av_interleaved_write_frame(output_format_context, &amp;output_packet);
</code></pre><ul>
<li><strong>Write trailer</strong></li>
</ul>
<pre><code class="language-language-cpp" data-lang="language-cpp">av_write_trailer(m_p_fmt_ctx);
</code></pre><ul>
<li><strong>Release</strong></li>
</ul>
<pre><code class="language-language-cpp" data-lang="language-cpp">avcodec_close(m_p_audio_stream-&gt;codec);
avio_close(m_p_fmt_ctx-&gt;pb);
avformat_free_context(m_p_fmt_ctx);
</code></pre><hr>
<p>#####Decoding（Based on 2.x）</p>
<ul>
<li><strong>Register all codec</strong></li>
</ul>
<pre><code class="language-language-cpp" data-lang="language-cpp">av_register_all();
avcodec_register_all();
</code></pre><ul>
<li><strong>Open File -&gt; find stream -&gt; find decoder -&gt; open decoder</strong></li>
</ul>
<pre><code class="language-language-cpp" data-lang="language-cpp">res = avformat_open_input(&amp;m_p_fmt_ctx, filename, NULL, NULL);
if (res &lt; 0) {
  LOGE(&quot;Could not open find stream info (error '%s')\n&quot;,
  get_error_text(res));
  goto EXIT;
}

/** Get information on the input file (number of streams etc.). */
res = avformat_find_stream_info(m_p_fmt_ctx, NULL);
if (res &lt; 0) {
  LOGE(&quot;Could not open find stream info (error '%s')\n&quot;, get_error_text(res));
  goto EXIT;
}

...//match stream via stream-&gt;codec-&gt;codec_type

if (m_p_video_stream) {
// Find the decoder for the video stream
  p_video_codec = avcodec_find_decoder(p_video_ctx-&gt;codec_id);
  if (!p_video_codec) {
    LOGE(&quot;avcodec_find_decoder() error: Unsupported video format or codec not found: %d. &quot;, p_video_ctx-&gt;codec_id);
}

// Open video codec
if (p_video_codec &amp;&amp; (res = avcodec_open2(p_video_ctx, p_video_codec, NULL)) &lt; 0) {
  LOGE(&quot;avcodec_open2() error %d: Could not open video codec.&quot;, res);
}
</code></pre><ul>
<li><strong>Decode</strong> //考虑到视频编码的特殊性（前后帧参考），所以这里一般是需要do-while的。</li>
</ul>
<pre><code class="language-language-cpp" data-lang="language-cpp">av_init_packet(&amp;pkt);

res = av_read_frame(m_p_fmt_ctx, &amp;pkt);
if (res &lt; 0) {
  av_free_packet(&amp;pkt);
  break;
}

...

// Decode frame
decoded_length = avcodec_decode_video2(m_p_video_stream-&gt;codec, temp_frame, &amp;got_frame, &amp;pkt);

av_free_packet(&amp;pkt);
</code></pre><ul>
<li><strong>Release</strong></li>
</ul>
<pre><code class="language-language-cpp" data-lang="language-cpp">avcodec_close(m_p_audio_stream-&gt;codec);
avformat_close_input(&amp;m_p_fmt_ctx);
</code></pre><hr>
<p>####Video/Audio格式转换（对齐）
不管是audio还是video，编码前/解码后都需要做格式转换，来保持数据格式的一致性。不然拿RGBA的数据直接送给等待NV12的encoder也不太好吧～</p>
<p>Video做格式转换是通过<code>sws_scale</code>（scale）；需要注意的是，<em>decoder/encoder需要对数据做一次对齐（为了XX位对齐做的buffer填充）</em>，换言之，即使是640 x 640的视频，decode出来的数据也不可以直接用，而需要scale一次来消除“渐隐区”（文档貌似没写，翻源码吧亲）。</p>
<p>Audio做格式转换是通过<code>swr_convert</code>（resample），用法类似<code>sws_scale</code>。</p>
<p>但audio有一点不同在于，video是一帧一帧的，而audio，就是一段连续数据而已。所以一帧video frame在scale以后还是一帧video frame；但一段长度为A（表示对应时长为Ta）的audio buffer在resample之后很可能就变成了长度为B（表示对应时长依然为Ta）的audio buffer。</p>
<p>举个简单例子，其他格式都一样，格式为8位（<code>AV_SAMPLE_FMT_S8</code>）的audio buffer，转换为16位（<code>AV_SAMPLE_FMT_S16</code>）后buffer长度会翻倍。这个“转换公式”很好理解吧，当然格式差异很多的时候，这个转换公式也跟着会复杂的多。（当然如果无视buffer格式差异，某些case下也是可以正常encode/decode的，但声音就不对了～）</p>
<p>长度的不同，导致了在decode/encode时需要一个额外的机制，来配合“对齐”（这里用对齐似乎更合适吧）buffer。</p>
<p>也就有了下文的FIFO（2.x版本后提供了<code>av_audio_fifo_xxx</code>的一系列接口，在这之前，audio接口调用逻辑和video接口差别很多，FIFO直接被整合在audio接口中而并未独立出来；听起来有点像是为了框架清晰而增加调用复杂度的故事 ^_^）</p>
<p>####Audio FIFO
在编码前/解码后，audio buffer为了保持格式（这里的格式包括采样率等）上的一致性，需要先通过FIFO进行一次buffer的重整。</p>
<p>即：</p>
<blockquote>
<p>解码：Decode -&gt; FIFO -&gt; Resample-&gt; audio buffer expected</p>
</blockquote>
<blockquote>
<p>编码：audio buffer expected -&gt; Resample -&gt; FIFO -&gt; Encode</p>
</blockquote>
<p>举个例子，假设一段待Encode的audio buffer格式为8位，长度（framesize）为4096；encoder期望的格式是16位，长度为4096；处理流程为：</p>
<ol>
<li>
<p>audio buffer A在通过Resample后会先被转换为长度为<em><strong>8192</strong></em>的16位buffer B；</p>
</li>
<li>
<p>write buffer B到FIFO中</p>
</li>
<li>
<p>从FIFO中read出长度为4096的buffer C</p>
</li>
<li>
<p>Encode buffer C</p>
</li>
<li>
<p>3-4循环</p>
</li>
</ol>
<p>调用起来和一般的fifo队列基本一致，EOF的时候注意对剩余buffer进行处理（一般是少的部分填空白）就好了。</p>
<p>####内存泄露
（版本2.4.3）对，就是内存泄露。更准确的说，是一些ffmpeg内部api的“特殊”逻辑，导致了内存泄露。</p>
<p>还记得前面提到的，用sws_scale来处理的“渐隐区”么？ 如果存在渐隐区，就意味着，每次ffmpeg都需要一块额外的buffer，来作为实际encode之前的一个缓冲区。</p>
<p>比较好的方案是一开始create一个temporary buffer，最后释放掉；差一点的方案，即使每次都申请，那么至少每次call <code>av_free_packet</code>的时候也应该释放掉；当然我们每次都“臆测”ffmpeg已经做了至少差一点的方案吧。</p>
<p>但FFmpeg采用的方案是。。。<strong>不 去 释 放</strong> 。。。（好吧，很难说这就是ffmpeg的issue，也可以被解释成调用逻辑不合理T_T）</p>
<p>所以如果发现app（想象一下：android工程，jni调用挂起so，用Monkeyrunner跑压力测试，通过排除法来看哪里出了内存泄露。。。也是醉了）有OOM，不妨往这个方向试试看。</p>
<p>（目前不确定最新的（2014/12/24,版本2.5.2）是否还存在这个情况，待补充）</p>
<p>####版本差异（尤其是老版本与2.x的差异）
研究不多，个人面对的最大的差异体现在audio部分（其他部分都是参数数量/类型的细微调整，无关调用逻辑）；</p>
<p>为了保持audio/video的decode/encode接口基本一致（洁癖嘛？），FIFO被剥离，导致audio调用逻辑相比较之前要复杂一些；</p>
<p>好处嘛，首先代码看起来舒服多了，其次就是可以“跟”上ffmpeg平均两周一更的步伐（这算好事吧？）</p>
<p>####Android版本编译
直接参考<a href="http://www.roman10.net/how-to-build-ffmpeg-with-ndk-r9/">Roman的文章</a>即可。
NDK R10类似。</p>
<p>当然也可以直接用这个<a href="http://chloette.github.io/ffmpeg4android/">ffmpeg4android@github</a>（也是我在维护）</p>
<p>####FFmpegAdapter
源码上传到<a href="http://chloette.github.io/FFmpegAdapter/">FFmpegAdapter@github</a>，草草上传（疏漏甚多，以后会尽量保持更新）。</p>
<p>最简单的用法就是直接inherit，这样load-library，jni接口映射（这里使用的是ndk默认映射机制，不是manual那套），error-code等都不需要单独写，至少我是这么直接用的。</p>
<p>主要目的是规避GPL开源风险，副产品是清晰了框架。试试看吧。</p>

      </article>
      
    </main>
    <nav class="end-nav side-padding">
      
      <a ontouchstart="cardPressed.call(this)" ontouchend="cardReleased.call(this)" ontouchmove="cardReleased.call(this)" 
  href="/posts/astrill-vpn/" class="card blog-card" rel="bookmark" >
  
  <article class="card-body">
    <h2 class="card-title">Astrill VPN</h2>
    <p class="card-text"></p>
    <div class="card-subtext muted-text">
      <p>Posted <time datetime="2014-12-23 1223:00">Dec 23, 2014</time></p>
      <p>#记录 #自用推荐 #值得花钱 </p>
    </div>
  </article>
</a>
      
      <a ontouchstart="cardPressed.call(this)" ontouchend="cardReleased.call(this)" ontouchmove="cardReleased.call(this)" 
  href="/" class="card home-card" style="background-image: url( /img/grey-cloud.jpg )" rel="bookmark" >
  Home
</a>
    </nav>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.13.1/highlight.min.js"></script>
<script defer src="https://cdn.jsdelivr.net/npm/katex@0.10.0/dist/katex.min.js" integrity="sha384-K3vbOmF2BtaVai+Qk37uypf7VrgBubhQreNQe9aGsz9lB63dIFiQVlJbr92dw2Lx" crossorigin="anonymous"></script>
<script defer src="https://cdn.jsdelivr.net/npm/katex@0.10.0/dist/contrib/auto-render.min.js" integrity="sha384-kmZOZB5ObwgQnS/DuDg6TScgOiWWBiVt0plIRkZCmE6rDZGrEOQeHM5PcHi+nyqe" crossorigin="anonymous"
    onload="renderMathInElement(document.body);"></script>
  
  <script src="/js/core.min.js"></script>
<script>
  hljs.initHighlightingOnLoad();
</script>

  </body>
</html>