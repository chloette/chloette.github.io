<!DOCTYPE html>
<html lang="en">
  <head>
    
      <title>å…³äºFFmpegï¼ˆè¿›é˜¶ï¼‰ :: ä½ å¥½ï¼Œä¸–ç•Œ â€” ğŸ“ğŸ¢ğŸ¿ğŸ›¹</title>
    
    <meta http-equiv="content-type" content="text/html; charset=utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1">
<meta name="description" content="åŸºæœ¬ç¯‡åœ¨æ­¤ã€‚
ç›®å‰ä»…ä½¿ç”¨åˆ°äº†ffmpegçš„è¯»å†™æ–‡ä»¶/ç¼–è§£ç åŠŸèƒ½ï¼Œå¹¶æœªä½¿ç”¨å…¶å»ç›´æ¥æ¸²æŸ“ã€‚
è¿™é‡Œè¯´æ˜¯è¿›é˜¶ï¼Œå…¶å®ä¹Ÿåªèƒ½ç®—æµ®äºè¡¨é¢ã€‚å› æ­¤ä¸»è¦è®°å½•ä½¿ç”¨ffmpegä»¥æ¥é‡åˆ°çš„å‘ï¼Œç‰ˆæœ¬å·®å¼‚ï¼Œandroidç‰ˆæœ¬ç¼–è¯‘ç­‰ã€‚Soï¼Œè¿™é‡Œå°±ä¸ç»§ç»­é‡‡ç”¨Q&amp;amp;Açš„æ–¹å¼äº†ã€‚
ï¼ˆæœ¬æ–‡å¹¶éé€šè¿‡ffmpeg.exe\binä¼ é€’commandæ¥è¿›è¡Œå¤„ç†ï¼Œè€Œæ˜¯ç›´æ¥è°ƒç”¨ffmpegç›¸å…³librariesä¸­çš„apiï¼‰
####FFmpeg libraries FFmpegæœ‰ä»¥ä¸‹åº“ï¼šï¼ˆ2014/12/24 ffmpeg 2.5.2ï¼‰ï¼Œä¸»è¦åŠŸèƒ½åˆ—åœ¨Aboutä¸­æœ‰åŸºæœ¬ä»‹ç»ï¼Œè¿™é‡Œä¸å†èµ˜è¿°ã€‚
 libavutil 54. 15.100 libavcodec 56. 13.100 libavformat 56. 15.102 libavdevice 56. 3.100 &amp;mdash; æœªä½¿ç”¨ libavfilter 5. 2.103 &amp;mdash; æœªä½¿ç”¨ libavresample 2. 1. 0 &amp;mdash; æœªä½¿ç”¨ libswscale 3. 1.101 libswresample 1. 1.100 libpostproc 53. 3.100 &amp;mdash; æœªä½¿ç”¨   ####FFmpegåŸºæœ¬ é¦–å…ˆï¼Œå®˜æ–¹æ–‡æ¡£ä¸ºç¬¬ä¸€å‚è€ƒæ–‡æ¡£ï¼›å…¶æ¬¡å°±æ˜¯æºç ï¼ˆè¿™é‡ŒæŠŠ*æºç *æ”¾åˆ°è¿™ä¹ˆé å‰çš„åŸå› ä¸‹æ–‡ä¼šæåˆ°ï¼‰ã€‚
FFmpegçš„å®˜æ–¹æ–‡æ¡£ç®—æ˜¯æ¯”è¾ƒå…¨çš„ã€‚ ä¸€äº›å¸¸è§caseçš„testbedéƒ½å¯ä»¥æ‰¾å¾—åˆ°ï¼›ä¾‹å¦‚2.5ç‰ˆæœ¬ï¼Œç¼–è§£ç çš„sample
åŒæ—¶å®˜æ–¹çš„ä¾‹å­å¹¶éæµ…æ˜¾æ˜“æ‡‚ï¼Œä½†æ˜¯å› ä¸ºå±‚æ¬¡ç®€å•ï¼Œæ‰€ä»¥è°ƒç”¨é€»è¾‘å¾ˆæ¸…æ¥šï¼›å‚è€ƒç€è¿™äº›æ–‡æ¡£/Sampleå°±å¯ä»¥æŒ‰éœ€è®¾è®¡ä¸€ä¸ªç®€åŒ–ç‰ˆAdapteräº†ã€‚
####FFmpegåŸºæœ¬è°ƒç”¨é€»è¾‘ è¿˜è®°å¾—Decode/Encodeå’ŒMuxer/Demuxerå§ï¼Œå¦‚æœè¿˜è®°å¾—é‚£å°±å¾ˆå¥½ç†è§£äº†ã€‚ä¸‹é¢æˆªé€‰äº†éƒ¨åˆ†ä»£ç ï¼ˆä¸è¦åœ¨æ„ç»†èŠ‚ï¼‰ï¼Œæœ‰ä¸€äº›é‡è¦å…³é”®ä½†éæµç¨‹ç›¸å…³çš„æ­¥éª¤è¿™é‡Œå…ˆçœç•¥ï¼ˆä¾‹å¦‚FIFOç­‰ï¼‰ï¼Œä¸‹æ–‡å†æã€‚
#####Encodingï¼ˆBased on 2.xï¼‰ - Register all codec //åº”è¯¥æ˜¯pluginçš„æœºåˆ¶
av_register_all(); avcodec_register_all();   Find encoder -&amp;gt; create stream -&amp;gt; open encoder  /* find the audio encoder */ p_audio_codec = avcodec_find_encoder(m_p_fmt_ctx-&amp;gt;oformat-&amp;gt;audio_codec); if (!"/>
<meta name="keywords" content=""/>
<meta name="robots" content="noodp"/>
<link rel="canonical" href="/posts/about-ffmpeg-advance/" />


<link rel="stylesheet" href="/assets/style.css">


<link rel="stylesheet" href="/style.css">


<link rel="apple-touch-icon-precomposed" sizes="144x144" href="/img/apple-touch-icon-144-precomposed.png">
<link rel="shortcut icon" href="/img/favicon.png">


<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="å…³äºFFmpegï¼ˆè¿›é˜¶ï¼‰"/>
<meta name="twitter:description" content="åŸºæœ¬ç¯‡åœ¨æ­¤ã€‚
ç›®å‰ä»…ä½¿ç”¨åˆ°äº†ffmpegçš„è¯»å†™æ–‡ä»¶/ç¼–è§£ç åŠŸèƒ½ï¼Œå¹¶æœªä½¿ç”¨å…¶å»ç›´æ¥æ¸²æŸ“ã€‚
è¿™é‡Œè¯´æ˜¯è¿›é˜¶ï¼Œå…¶å®ä¹Ÿåªèƒ½ç®—æµ®äºè¡¨é¢ã€‚å› æ­¤ä¸»è¦è®°å½•ä½¿ç”¨ffmpegä»¥æ¥é‡åˆ°çš„å‘ï¼Œç‰ˆæœ¬å·®å¼‚ï¼Œandroidç‰ˆæœ¬ç¼–è¯‘ç­‰ã€‚Soï¼Œè¿™é‡Œå°±ä¸ç»§ç»­é‡‡ç”¨Q&amp;Açš„æ–¹å¼äº†ã€‚
ï¼ˆæœ¬æ–‡å¹¶éé€šè¿‡ffmpeg.exe\binä¼ é€’commandæ¥è¿›è¡Œå¤„ç†ï¼Œè€Œæ˜¯ç›´æ¥è°ƒç”¨ffmpegç›¸å…³librariesä¸­çš„apiï¼‰
####FFmpeg libraries FFmpegæœ‰ä»¥ä¸‹åº“ï¼šï¼ˆ2014/12/24 ffmpeg 2.5.2ï¼‰ï¼Œä¸»è¦åŠŸèƒ½åˆ—åœ¨Aboutä¸­æœ‰åŸºæœ¬ä»‹ç»ï¼Œè¿™é‡Œä¸å†èµ˜è¿°ã€‚
 libavutil 54. 15.100 libavcodec 56. 13.100 libavformat 56. 15.102 libavdevice 56. 3.100 &mdash; æœªä½¿ç”¨ libavfilter 5. 2.103 &mdash; æœªä½¿ç”¨ libavresample 2. 1. 0 &mdash; æœªä½¿ç”¨ libswscale 3. 1.101 libswresample 1. 1.100 libpostproc 53. 3.100 &mdash; æœªä½¿ç”¨   ####FFmpegåŸºæœ¬ é¦–å…ˆï¼Œå®˜æ–¹æ–‡æ¡£ä¸ºç¬¬ä¸€å‚è€ƒæ–‡æ¡£ï¼›å…¶æ¬¡å°±æ˜¯æºç ï¼ˆè¿™é‡ŒæŠŠ*æºç *æ”¾åˆ°è¿™ä¹ˆé å‰çš„åŸå› ä¸‹æ–‡ä¼šæåˆ°ï¼‰ã€‚
FFmpegçš„å®˜æ–¹æ–‡æ¡£ç®—æ˜¯æ¯”è¾ƒå…¨çš„ã€‚ ä¸€äº›å¸¸è§caseçš„testbedéƒ½å¯ä»¥æ‰¾å¾—åˆ°ï¼›ä¾‹å¦‚2.5ç‰ˆæœ¬ï¼Œç¼–è§£ç çš„sample
åŒæ—¶å®˜æ–¹çš„ä¾‹å­å¹¶éæµ…æ˜¾æ˜“æ‡‚ï¼Œä½†æ˜¯å› ä¸ºå±‚æ¬¡ç®€å•ï¼Œæ‰€ä»¥è°ƒç”¨é€»è¾‘å¾ˆæ¸…æ¥šï¼›å‚è€ƒç€è¿™äº›æ–‡æ¡£/Sampleå°±å¯ä»¥æŒ‰éœ€è®¾è®¡ä¸€ä¸ªç®€åŒ–ç‰ˆAdapteräº†ã€‚
####FFmpegåŸºæœ¬è°ƒç”¨é€»è¾‘ è¿˜è®°å¾—Decode/Encodeå’ŒMuxer/Demuxerå§ï¼Œå¦‚æœè¿˜è®°å¾—é‚£å°±å¾ˆå¥½ç†è§£äº†ã€‚ä¸‹é¢æˆªé€‰äº†éƒ¨åˆ†ä»£ç ï¼ˆä¸è¦åœ¨æ„ç»†èŠ‚ï¼‰ï¼Œæœ‰ä¸€äº›é‡è¦å…³é”®ä½†éæµç¨‹ç›¸å…³çš„æ­¥éª¤è¿™é‡Œå…ˆçœç•¥ï¼ˆä¾‹å¦‚FIFOç­‰ï¼‰ï¼Œä¸‹æ–‡å†æã€‚
#####Encodingï¼ˆBased on 2.xï¼‰ - Register all codec //åº”è¯¥æ˜¯pluginçš„æœºåˆ¶
av_register_all(); avcodec_register_all();   Find encoder -&gt; create stream -&gt; open encoder  /* find the audio encoder */ p_audio_codec = avcodec_find_encoder(m_p_fmt_ctx-&gt;oformat-&gt;audio_codec); if (!"/>



<meta property="og:title" content="å…³äºFFmpegï¼ˆè¿›é˜¶ï¼‰" />
<meta property="og:description" content="åŸºæœ¬ç¯‡åœ¨æ­¤ã€‚
ç›®å‰ä»…ä½¿ç”¨åˆ°äº†ffmpegçš„è¯»å†™æ–‡ä»¶/ç¼–è§£ç åŠŸèƒ½ï¼Œå¹¶æœªä½¿ç”¨å…¶å»ç›´æ¥æ¸²æŸ“ã€‚
è¿™é‡Œè¯´æ˜¯è¿›é˜¶ï¼Œå…¶å®ä¹Ÿåªèƒ½ç®—æµ®äºè¡¨é¢ã€‚å› æ­¤ä¸»è¦è®°å½•ä½¿ç”¨ffmpegä»¥æ¥é‡åˆ°çš„å‘ï¼Œç‰ˆæœ¬å·®å¼‚ï¼Œandroidç‰ˆæœ¬ç¼–è¯‘ç­‰ã€‚Soï¼Œè¿™é‡Œå°±ä¸ç»§ç»­é‡‡ç”¨Q&amp;Açš„æ–¹å¼äº†ã€‚
ï¼ˆæœ¬æ–‡å¹¶éé€šè¿‡ffmpeg.exe\binä¼ é€’commandæ¥è¿›è¡Œå¤„ç†ï¼Œè€Œæ˜¯ç›´æ¥è°ƒç”¨ffmpegç›¸å…³librariesä¸­çš„apiï¼‰
####FFmpeg libraries FFmpegæœ‰ä»¥ä¸‹åº“ï¼šï¼ˆ2014/12/24 ffmpeg 2.5.2ï¼‰ï¼Œä¸»è¦åŠŸèƒ½åˆ—åœ¨Aboutä¸­æœ‰åŸºæœ¬ä»‹ç»ï¼Œè¿™é‡Œä¸å†èµ˜è¿°ã€‚
 libavutil 54. 15.100 libavcodec 56. 13.100 libavformat 56. 15.102 libavdevice 56. 3.100 &mdash; æœªä½¿ç”¨ libavfilter 5. 2.103 &mdash; æœªä½¿ç”¨ libavresample 2. 1. 0 &mdash; æœªä½¿ç”¨ libswscale 3. 1.101 libswresample 1. 1.100 libpostproc 53. 3.100 &mdash; æœªä½¿ç”¨   ####FFmpegåŸºæœ¬ é¦–å…ˆï¼Œå®˜æ–¹æ–‡æ¡£ä¸ºç¬¬ä¸€å‚è€ƒæ–‡æ¡£ï¼›å…¶æ¬¡å°±æ˜¯æºç ï¼ˆè¿™é‡ŒæŠŠ*æºç *æ”¾åˆ°è¿™ä¹ˆé å‰çš„åŸå› ä¸‹æ–‡ä¼šæåˆ°ï¼‰ã€‚
FFmpegçš„å®˜æ–¹æ–‡æ¡£ç®—æ˜¯æ¯”è¾ƒå…¨çš„ã€‚ ä¸€äº›å¸¸è§caseçš„testbedéƒ½å¯ä»¥æ‰¾å¾—åˆ°ï¼›ä¾‹å¦‚2.5ç‰ˆæœ¬ï¼Œç¼–è§£ç çš„sample
åŒæ—¶å®˜æ–¹çš„ä¾‹å­å¹¶éæµ…æ˜¾æ˜“æ‡‚ï¼Œä½†æ˜¯å› ä¸ºå±‚æ¬¡ç®€å•ï¼Œæ‰€ä»¥è°ƒç”¨é€»è¾‘å¾ˆæ¸…æ¥šï¼›å‚è€ƒç€è¿™äº›æ–‡æ¡£/Sampleå°±å¯ä»¥æŒ‰éœ€è®¾è®¡ä¸€ä¸ªç®€åŒ–ç‰ˆAdapteräº†ã€‚
####FFmpegåŸºæœ¬è°ƒç”¨é€»è¾‘ è¿˜è®°å¾—Decode/Encodeå’ŒMuxer/Demuxerå§ï¼Œå¦‚æœè¿˜è®°å¾—é‚£å°±å¾ˆå¥½ç†è§£äº†ã€‚ä¸‹é¢æˆªé€‰äº†éƒ¨åˆ†ä»£ç ï¼ˆä¸è¦åœ¨æ„ç»†èŠ‚ï¼‰ï¼Œæœ‰ä¸€äº›é‡è¦å…³é”®ä½†éæµç¨‹ç›¸å…³çš„æ­¥éª¤è¿™é‡Œå…ˆçœç•¥ï¼ˆä¾‹å¦‚FIFOç­‰ï¼‰ï¼Œä¸‹æ–‡å†æã€‚
#####Encodingï¼ˆBased on 2.xï¼‰ - Register all codec //åº”è¯¥æ˜¯pluginçš„æœºåˆ¶
av_register_all(); avcodec_register_all();   Find encoder -&gt; create stream -&gt; open encoder  /* find the audio encoder */ p_audio_codec = avcodec_find_encoder(m_p_fmt_ctx-&gt;oformat-&gt;audio_codec); if (!" />
<meta property="og:type" content="article" />
<meta property="og:url" content="/posts/about-ffmpeg-advance/" />
<meta property="article:published_time" content="2014-12-24T09:11:09&#43;00:00"/>
<meta property="article:modified_time" content="2014-12-24T09:11:09&#43;00:00"/><meta property="og:site_name" content="ä½ å¥½ï¼Œä¸–ç•Œ" />






  </head>
  <body class="dark-theme">
    <div class="container">
      <header class="header">
  <span class="header__inner">
    <a href="/" class="logo" style="text-decoration: none;">
  
    <span class="logo__mark"><svg xmlns="http://www.w3.org/2000/svg" class="greater-icon" width="44" height="44" viewBox="0 0 44 44">
  <polyline fill="none" stroke="#000" stroke-width="2" points="15 8 29.729 22.382 15 35.367"/>
</svg>
</span>
    <span class="logo__text">Hello World</span>
    <span class="logo__cursor"></span>
  
</a>

    <span class="header__right">
      
        <nav class="menu">
  <ul class="menu__inner menu__inner--desktop">
    
      
        
          <li><a href="/about">About</a></li>
        
      
      
    
  </ul>

  <ul class="menu__inner menu__inner--mobile">
    
      
        <li><a href="/about">About</a></li>
      
    
  </ul>
</nav>

        <span class="menu-trigger">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
            <path d="M0 0h24v24H0z" fill="none"/>
            <path d="M3 18h18v-2H3v2zm0-5h18v-2H3v2zm0-7v2h18V6H3z"/>
          </svg>
        </span>
      
      <span class="theme-toggle">
        <svg class="theme-toggler" width="24" height="24" viewBox="0 0 48 48" fill="none" xmlns="http://www.w3.org/2000/svg">
  <path d="M22 41C32.4934 41 41 32.4934 41 22C41 11.5066 32.4934 3 22
  3C11.5066 3 3 11.5066 3 22C3 32.4934 11.5066 41 22 41ZM7 22C7
  13.7157 13.7157 7 22 7V37C13.7157 37 7 30.2843 7 22Z"/>
</svg>

      </span>
    </span>
  </span>
</header>


      <div class="content">
        
  <div class="post">
    <h2 class="post-title"><a href="/posts/about-ffmpeg-advance/">å…³äºFFmpegï¼ˆè¿›é˜¶ï¼‰</a></h2>
    <div class="post-meta">
      
        <span class="post-date">
            2014-12-24
        </span>
      
      <span class="post-author">â€” Written by Guo Yi</span>
      
    </div>

    
      <span class="post-tags">
        
          #<a href="/tags/%E6%8A%80%E6%9C%AF/">æŠ€æœ¯</a>&nbsp;
        
          #<a href="/tags/ffmpeg/">ffmpeg</a>&nbsp;
        
      </span>
    

    

    <div class="post-content">
      <p>åŸºæœ¬ç¯‡<a href="http://nobodycare.me/2014/09/29/about-ffmpeg-basic/">åœ¨æ­¤</a>ã€‚</p>

<p>ç›®å‰ä»…ä½¿ç”¨åˆ°äº†ffmpegçš„è¯»å†™æ–‡ä»¶/ç¼–è§£ç åŠŸèƒ½ï¼Œå¹¶æœªä½¿ç”¨å…¶å»ç›´æ¥æ¸²æŸ“ã€‚</p>

<p>è¿™é‡Œè¯´æ˜¯è¿›é˜¶ï¼Œå…¶å®ä¹Ÿåªèƒ½ç®—æµ®äºè¡¨é¢ã€‚å› æ­¤ä¸»è¦è®°å½•ä½¿ç”¨ffmpegä»¥æ¥é‡åˆ°çš„å‘ï¼Œç‰ˆæœ¬å·®å¼‚ï¼Œandroidç‰ˆæœ¬ç¼–è¯‘ç­‰ã€‚Soï¼Œè¿™é‡Œå°±ä¸ç»§ç»­é‡‡ç”¨Q&amp;Açš„æ–¹å¼äº†ã€‚</p>

<p>ï¼ˆæœ¬æ–‡å¹¶éé€šè¿‡ffmpeg.exe\binä¼ é€’commandæ¥è¿›è¡Œå¤„ç†ï¼Œè€Œæ˜¯ç›´æ¥è°ƒç”¨ffmpegç›¸å…³librariesä¸­çš„apiï¼‰</p>

<p>####FFmpeg libraries
FFmpegæœ‰ä»¥ä¸‹åº“ï¼šï¼ˆ2014/12/24 ffmpeg 2.5.2ï¼‰ï¼Œä¸»è¦åŠŸèƒ½åˆ—åœ¨<a href="http://ffmpeg.org/about.html">About</a>ä¸­æœ‰åŸºæœ¬ä»‹ç»ï¼Œè¿™é‡Œä¸å†èµ˜è¿°ã€‚</p>

<ul>
<li>libavutil      54. 15.100</li>
<li>libavcodec     56. 13.100</li>
<li>libavformat    56. 15.102</li>
<li>libavdevice    56.  3.100 &mdash; æœªä½¿ç”¨</li>
<li>libavfilter     5.  2.103 &mdash; æœªä½¿ç”¨</li>
<li>libavresample   2.  1.  0 &mdash; æœªä½¿ç”¨</li>
<li>libswscale      3.  1.101</li>
<li>libswresample   1.  1.100</li>
<li>libpostproc    53.  3.100 &mdash; æœªä½¿ç”¨
<br /></li>
</ul>

<p>####FFmpegåŸºæœ¬
é¦–å…ˆï¼Œå®˜æ–¹æ–‡æ¡£ä¸ºç¬¬ä¸€å‚è€ƒæ–‡æ¡£ï¼›å…¶æ¬¡å°±æ˜¯æºç ï¼ˆè¿™é‡ŒæŠŠ*æºç *æ”¾åˆ°è¿™ä¹ˆé å‰çš„åŸå› ä¸‹æ–‡ä¼šæåˆ°ï¼‰ã€‚</p>

<p>FFmpegçš„<a href="http://ffmpeg.org/doxygen/">å®˜æ–¹æ–‡æ¡£</a>ç®—æ˜¯æ¯”è¾ƒå…¨çš„ã€‚
ä¸€äº›å¸¸è§caseçš„testbedéƒ½å¯ä»¥æ‰¾å¾—åˆ°ï¼›ä¾‹å¦‚2.5ç‰ˆæœ¬ï¼Œç¼–è§£ç çš„<a href="http://ffmpeg.org/doxygen/2.5/decoding_encoding_8c-example.html">sample</a></p>

<p>åŒæ—¶å®˜æ–¹çš„ä¾‹å­å¹¶éæµ…æ˜¾æ˜“æ‡‚ï¼Œä½†æ˜¯å› ä¸ºå±‚æ¬¡ç®€å•ï¼Œæ‰€ä»¥è°ƒç”¨é€»è¾‘å¾ˆæ¸…æ¥šï¼›å‚è€ƒç€è¿™äº›æ–‡æ¡£/Sampleå°±å¯ä»¥æŒ‰éœ€è®¾è®¡ä¸€ä¸ªç®€åŒ–ç‰ˆAdapteräº†ã€‚</p>

<p>####FFmpegåŸºæœ¬è°ƒç”¨é€»è¾‘
è¿˜è®°å¾—Decode/Encodeå’ŒMuxer/Demuxerå§ï¼Œå¦‚æœè¿˜è®°å¾—é‚£å°±å¾ˆå¥½ç†è§£äº†ã€‚ä¸‹é¢æˆªé€‰äº†éƒ¨åˆ†ä»£ç ï¼ˆä¸è¦åœ¨æ„ç»†èŠ‚ï¼‰ï¼Œæœ‰ä¸€äº›é‡è¦å…³é”®ä½†éæµç¨‹ç›¸å…³çš„æ­¥éª¤è¿™é‡Œå…ˆçœç•¥ï¼ˆä¾‹å¦‚FIFOç­‰ï¼‰ï¼Œä¸‹æ–‡å†æã€‚</p>

<hr />

<p>#####Encodingï¼ˆBased on 2.xï¼‰
- <strong>Register all codec</strong> //åº”è¯¥æ˜¯pluginçš„æœºåˆ¶</p>

<pre><code class="language-language-cpp">av_register_all();
avcodec_register_all();
</code></pre>

<ul>
<li><strong>Find encoder -&gt; create stream -&gt; open encoder</strong></li>
</ul>

<pre><code class="language-language-cpp">/* find the audio encoder */
p_audio_codec = avcodec_find_encoder(m_p_fmt_ctx-&gt;oformat-&gt;audio_codec);
if (!p_audio_codec) {
  res = ErrorNoEncoderFound;
  goto EXIT;
}

// Try create stream.
m_p_audio_stream = avformat_new_stream(m_p_fmt_ctx, p_audio_codec);
if (!m_p_audio_stream) {
  LOGE(&quot;Cannot add new audio stream\n&quot;);
  res = ErrorNoStreamFound;
  goto EXIT;
}

p_codec_ctx = m_p_audio_stream-&gt;codec;
... //some regular configurations on encoder

// open the codec.
res = avcodec_open2(p_codec_ctx, p_audio_codec, &amp;p_options);
CHK_RES(res);
</code></pre>

<ul>
<li><strong>Open File -&gt; write header</strong></li>
</ul>

<pre><code class="language-language-c">res = avio_open(&amp;m_p_fmt_ctx-&gt;pb, m_p_file_path, AVIO_FLAG_WRITE);
...
res = avformat_write_header(m_p_fmt_ctx, NULL);
...
</code></pre>

<ul>
<li><strong>Encode</strong></li>
</ul>

<pre><code class="language-language-cpp">av_init_packet(&amp;output_packet);
 ...
res = avcodec_encode_audio2(output_audio_stream-&gt;codec, &amp;output_packet, frame, data_present);
...
res = av_interleaved_write_frame(output_format_context, &amp;output_packet);
</code></pre>

<ul>
<li><strong>Write trailer</strong></li>
</ul>

<pre><code class="language-language-cpp">av_write_trailer(m_p_fmt_ctx);
</code></pre>

<ul>
<li><strong>Release</strong></li>
</ul>

<pre><code class="language-language-cpp">avcodec_close(m_p_audio_stream-&gt;codec);
avio_close(m_p_fmt_ctx-&gt;pb);
avformat_free_context(m_p_fmt_ctx);
</code></pre>

<hr />

<p>#####Decodingï¼ˆBased on 2.xï¼‰
- <strong>Register all codec</strong></p>

<pre><code class="language-language-cpp">av_register_all();
avcodec_register_all();
</code></pre>

<ul>
<li><strong>Open File -&gt; find stream -&gt; find decoder -&gt; open decoder</strong></li>
</ul>

<pre><code class="language-language-cpp">res = avformat_open_input(&amp;m_p_fmt_ctx, filename, NULL, NULL);
if (res &lt; 0) {
  LOGE(&quot;Could not open find stream info (error '%s')\n&quot;,
  get_error_text(res));
  goto EXIT;
}

/** Get information on the input file (number of streams etc.). */
res = avformat_find_stream_info(m_p_fmt_ctx, NULL);
if (res &lt; 0) {
  LOGE(&quot;Could not open find stream info (error '%s')\n&quot;, get_error_text(res));
  goto EXIT;
}

...//match stream via stream-&gt;codec-&gt;codec_type

if (m_p_video_stream) {
// Find the decoder for the video stream
  p_video_codec = avcodec_find_decoder(p_video_ctx-&gt;codec_id);
  if (!p_video_codec) {
    LOGE(&quot;avcodec_find_decoder() error: Unsupported video format or codec not found: %d. &quot;, p_video_ctx-&gt;codec_id);
}

// Open video codec
if (p_video_codec &amp;&amp; (res = avcodec_open2(p_video_ctx, p_video_codec, NULL)) &lt; 0) {
  LOGE(&quot;avcodec_open2() error %d: Could not open video codec.&quot;, res);
}
</code></pre>

<ul>
<li><strong>Decode</strong> //è€ƒè™‘åˆ°è§†é¢‘ç¼–ç çš„ç‰¹æ®Šæ€§ï¼ˆå‰åå¸§å‚è€ƒï¼‰ï¼Œæ‰€ä»¥è¿™é‡Œä¸€èˆ¬æ˜¯éœ€è¦do-whileçš„ã€‚</li>
</ul>

<pre><code class="language-language-cpp">av_init_packet(&amp;pkt);

res = av_read_frame(m_p_fmt_ctx, &amp;pkt);
if (res &lt; 0) {
  av_free_packet(&amp;pkt);
  break;
}

...

// Decode frame
decoded_length = avcodec_decode_video2(m_p_video_stream-&gt;codec, temp_frame, &amp;got_frame, &amp;pkt);

av_free_packet(&amp;pkt);
</code></pre>

<ul>
<li><strong>Release</strong></li>
</ul>

<pre><code class="language-language-cpp">avcodec_close(m_p_audio_stream-&gt;codec);
avformat_close_input(&amp;m_p_fmt_ctx);
</code></pre>

<hr />

<p>####Video/Audioæ ¼å¼è½¬æ¢ï¼ˆå¯¹é½ï¼‰
ä¸ç®¡æ˜¯audioè¿˜æ˜¯videoï¼Œç¼–ç å‰/è§£ç åéƒ½éœ€è¦åšæ ¼å¼è½¬æ¢ï¼Œæ¥ä¿æŒæ•°æ®æ ¼å¼çš„ä¸€è‡´æ€§ã€‚ä¸ç„¶æ‹¿RGBAçš„æ•°æ®ç›´æ¥é€ç»™ç­‰å¾…NV12çš„encoderä¹Ÿä¸å¤ªå¥½å§ï½</p>

<p>Videoåšæ ¼å¼è½¬æ¢æ˜¯é€šè¿‡<code>sws_scale</code>ï¼ˆscaleï¼‰ï¼›éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œ*decoder/encoderéœ€è¦å¯¹æ•°æ®åšä¸€æ¬¡å¯¹é½ï¼ˆä¸ºäº†XXä½å¯¹é½åšçš„bufferå¡«å……ï¼‰*ï¼Œæ¢è¨€ä¹‹ï¼Œå³ä½¿æ˜¯640 x 640çš„è§†é¢‘ï¼Œdecodeå‡ºæ¥çš„æ•°æ®ä¹Ÿä¸å¯ä»¥ç›´æ¥ç”¨ï¼Œè€Œéœ€è¦scaleä¸€æ¬¡æ¥æ¶ˆé™¤â€œæ¸éšåŒºâ€ï¼ˆæ–‡æ¡£è²Œä¼¼æ²¡å†™ï¼Œç¿»æºç å§äº²ï¼‰ã€‚</p>

<p>Audioåšæ ¼å¼è½¬æ¢æ˜¯é€šè¿‡<code>swr_convert</code>ï¼ˆresampleï¼‰ï¼Œç”¨æ³•ç±»ä¼¼<code>sws_scale</code>ã€‚</p>

<p>ä½†audioæœ‰ä¸€ç‚¹ä¸åŒåœ¨äºï¼Œvideoæ˜¯ä¸€å¸§ä¸€å¸§çš„ï¼Œè€Œaudioï¼Œå°±æ˜¯ä¸€æ®µè¿ç»­æ•°æ®è€Œå·²ã€‚æ‰€ä»¥ä¸€å¸§video frameåœ¨scaleä»¥åè¿˜æ˜¯ä¸€å¸§video frameï¼›ä½†ä¸€æ®µé•¿åº¦ä¸ºAï¼ˆè¡¨ç¤ºå¯¹åº”æ—¶é•¿ä¸ºTaï¼‰çš„audio bufferåœ¨resampleä¹‹åå¾ˆå¯èƒ½å°±å˜æˆäº†é•¿åº¦ä¸ºBï¼ˆè¡¨ç¤ºå¯¹åº”æ—¶é•¿ä¾ç„¶ä¸ºTaï¼‰çš„audio bufferã€‚</p>

<p>ä¸¾ä¸ªç®€å•ä¾‹å­ï¼Œå…¶ä»–æ ¼å¼éƒ½ä¸€æ ·ï¼Œæ ¼å¼ä¸º8ä½ï¼ˆ<code>AV_SAMPLE_FMT_S8</code>ï¼‰çš„audio bufferï¼Œè½¬æ¢ä¸º16ä½ï¼ˆ<code>AV_SAMPLE_FMT_S16</code>ï¼‰åbufferé•¿åº¦ä¼šç¿»å€ã€‚è¿™ä¸ªâ€œè½¬æ¢å…¬å¼â€å¾ˆå¥½ç†è§£å§ï¼Œå½“ç„¶æ ¼å¼å·®å¼‚å¾ˆå¤šçš„æ—¶å€™ï¼Œè¿™ä¸ªè½¬æ¢å…¬å¼ä¹Ÿè·Ÿç€ä¼šå¤æ‚çš„å¤šã€‚ï¼ˆå½“ç„¶å¦‚æœæ— è§†bufferæ ¼å¼å·®å¼‚ï¼ŒæŸäº›caseä¸‹ä¹Ÿæ˜¯å¯ä»¥æ­£å¸¸encode/decodeçš„ï¼Œä½†å£°éŸ³å°±ä¸å¯¹äº†ï½ï¼‰</p>

<p>é•¿åº¦çš„ä¸åŒï¼Œå¯¼è‡´äº†åœ¨decode/encodeæ—¶éœ€è¦ä¸€ä¸ªé¢å¤–çš„æœºåˆ¶ï¼Œæ¥é…åˆâ€œå¯¹é½â€ï¼ˆè¿™é‡Œç”¨å¯¹é½ä¼¼ä¹æ›´åˆé€‚å§ï¼‰bufferã€‚</p>

<p>ä¹Ÿå°±æœ‰äº†ä¸‹æ–‡çš„FIFOï¼ˆ2.xç‰ˆæœ¬åæä¾›äº†<code>av_audio_fifo_xxx</code>çš„ä¸€ç³»åˆ—æ¥å£ï¼Œåœ¨è¿™ä¹‹å‰ï¼Œaudioæ¥å£è°ƒç”¨é€»è¾‘å’Œvideoæ¥å£å·®åˆ«å¾ˆå¤šï¼ŒFIFOç›´æ¥è¢«æ•´åˆåœ¨audioæ¥å£ä¸­è€Œå¹¶æœªç‹¬ç«‹å‡ºæ¥ï¼›å¬èµ·æ¥æœ‰ç‚¹åƒæ˜¯ä¸ºäº†æ¡†æ¶æ¸…æ™°è€Œå¢åŠ è°ƒç”¨å¤æ‚åº¦çš„æ•…äº‹ ^_^ï¼‰</p>

<p>####Audio FIFO
åœ¨ç¼–ç å‰/è§£ç åï¼Œaudio bufferä¸ºäº†ä¿æŒæ ¼å¼ï¼ˆè¿™é‡Œçš„æ ¼å¼åŒ…æ‹¬é‡‡æ ·ç‡ç­‰ï¼‰ä¸Šçš„ä¸€è‡´æ€§ï¼Œéœ€è¦å…ˆé€šè¿‡FIFOè¿›è¡Œä¸€æ¬¡bufferçš„é‡æ•´ã€‚</p>

<p>å³ï¼š</p>

<blockquote>
<p>è§£ç ï¼šDecode -&gt; FIFO -&gt; Resample-&gt; audio buffer expected</p>

<p>ç¼–ç ï¼šaudio buffer expected -&gt; Resample -&gt; FIFO -&gt; Encode</p>
</blockquote>

<p>ä¸¾ä¸ªä¾‹å­ï¼Œå‡è®¾ä¸€æ®µå¾…Encodeçš„audio bufferæ ¼å¼ä¸º8ä½ï¼Œé•¿åº¦ï¼ˆframesizeï¼‰ä¸º4096ï¼›encoderæœŸæœ›çš„æ ¼å¼æ˜¯16ä½ï¼Œé•¿åº¦ä¸º4096ï¼›å¤„ç†æµç¨‹ä¸ºï¼š</p>

<ol>
<li><p>audio buffer Aåœ¨é€šè¿‡Resampleåä¼šå…ˆè¢«è½¬æ¢ä¸ºé•¿åº¦ä¸º<strong><em>8192</em></strong>çš„16ä½buffer Bï¼›</p></li>

<li><p>write buffer Båˆ°FIFOä¸­</p></li>

<li><p>ä»FIFOä¸­readå‡ºé•¿åº¦ä¸º4096çš„buffer C</p></li>

<li><p>Encode buffer C</p></li>

<li><p>3-4å¾ªç¯</p></li>
</ol>

<p>è°ƒç”¨èµ·æ¥å’Œä¸€èˆ¬çš„fifoé˜Ÿåˆ—åŸºæœ¬ä¸€è‡´ï¼ŒEOFçš„æ—¶å€™æ³¨æ„å¯¹å‰©ä½™bufferè¿›è¡Œå¤„ç†ï¼ˆä¸€èˆ¬æ˜¯å°‘çš„éƒ¨åˆ†å¡«ç©ºç™½ï¼‰å°±å¥½äº†ã€‚</p>

<p>####å†…å­˜æ³„éœ²
ï¼ˆç‰ˆæœ¬2.4.3ï¼‰å¯¹ï¼Œå°±æ˜¯å†…å­˜æ³„éœ²ã€‚æ›´å‡†ç¡®çš„è¯´ï¼Œæ˜¯ä¸€äº›ffmpegå†…éƒ¨apiçš„â€œç‰¹æ®Šâ€é€»è¾‘ï¼Œå¯¼è‡´äº†å†…å­˜æ³„éœ²ã€‚</p>

<p>è¿˜è®°å¾—å‰é¢æåˆ°çš„ï¼Œç”¨sws_scaleæ¥å¤„ç†çš„â€œæ¸éšåŒºâ€ä¹ˆï¼Ÿ å¦‚æœå­˜åœ¨æ¸éšåŒºï¼Œå°±æ„å‘³ç€ï¼Œæ¯æ¬¡ffmpegéƒ½éœ€è¦ä¸€å—é¢å¤–çš„bufferï¼Œæ¥ä½œä¸ºå®é™…encodeä¹‹å‰çš„ä¸€ä¸ªç¼“å†²åŒºã€‚</p>

<p>æ¯”è¾ƒå¥½çš„æ–¹æ¡ˆæ˜¯ä¸€å¼€å§‹createä¸€ä¸ªtemporary bufferï¼Œæœ€åé‡Šæ”¾æ‰ï¼›å·®ä¸€ç‚¹çš„æ–¹æ¡ˆï¼Œå³ä½¿æ¯æ¬¡éƒ½ç”³è¯·ï¼Œé‚£ä¹ˆè‡³å°‘æ¯æ¬¡call <code>av_free_packet</code>çš„æ—¶å€™ä¹Ÿåº”è¯¥é‡Šæ”¾æ‰ï¼›å½“ç„¶æˆ‘ä»¬æ¯æ¬¡éƒ½â€œè‡†æµ‹â€ffmpegå·²ç»åšäº†è‡³å°‘å·®ä¸€ç‚¹çš„æ–¹æ¡ˆå§ã€‚</p>

<p>ä½†FFmpegé‡‡ç”¨çš„æ–¹æ¡ˆæ˜¯ã€‚ã€‚ã€‚<strong>ä¸ å» é‡Š æ”¾</strong> ã€‚ã€‚ã€‚ï¼ˆå¥½å§ï¼Œå¾ˆéš¾è¯´è¿™å°±æ˜¯ffmpegçš„issueï¼Œä¹Ÿå¯ä»¥è¢«è§£é‡Šæˆè°ƒç”¨é€»è¾‘ä¸åˆç†T_Tï¼‰</p>

<p>æ‰€ä»¥å¦‚æœå‘ç°appï¼ˆæƒ³è±¡ä¸€ä¸‹ï¼šandroidå·¥ç¨‹ï¼Œjniè°ƒç”¨æŒ‚èµ·soï¼Œç”¨Monkeyrunnerè·‘å‹åŠ›æµ‹è¯•ï¼Œé€šè¿‡æ’é™¤æ³•æ¥çœ‹å“ªé‡Œå‡ºäº†å†…å­˜æ³„éœ²ã€‚ã€‚ã€‚ä¹Ÿæ˜¯é†‰äº†ï¼‰æœ‰OOMï¼Œä¸å¦¨å¾€è¿™ä¸ªæ–¹å‘è¯•è¯•çœ‹ã€‚</p>

<p>ï¼ˆç›®å‰ä¸ç¡®å®šæœ€æ–°çš„ï¼ˆ2014/12/24,ç‰ˆæœ¬2.5.2ï¼‰æ˜¯å¦è¿˜å­˜åœ¨è¿™ä¸ªæƒ…å†µï¼Œå¾…è¡¥å……ï¼‰</p>

<p>####ç‰ˆæœ¬å·®å¼‚ï¼ˆå°¤å…¶æ˜¯è€ç‰ˆæœ¬ä¸2.xçš„å·®å¼‚ï¼‰
ç ”ç©¶ä¸å¤šï¼Œä¸ªäººé¢å¯¹çš„æœ€å¤§çš„å·®å¼‚ä½“ç°åœ¨audioéƒ¨åˆ†ï¼ˆå…¶ä»–éƒ¨åˆ†éƒ½æ˜¯å‚æ•°æ•°é‡/ç±»å‹çš„ç»†å¾®è°ƒæ•´ï¼Œæ— å…³è°ƒç”¨é€»è¾‘ï¼‰ï¼›</p>

<p>ä¸ºäº†ä¿æŒaudio/videoçš„decode/encodeæ¥å£åŸºæœ¬ä¸€è‡´ï¼ˆæ´ç™–å˜›ï¼Ÿï¼‰ï¼ŒFIFOè¢«å‰¥ç¦»ï¼Œå¯¼è‡´audioè°ƒç”¨é€»è¾‘ç›¸æ¯”è¾ƒä¹‹å‰è¦å¤æ‚ä¸€äº›ï¼›</p>

<p>å¥½å¤„å˜›ï¼Œé¦–å…ˆä»£ç çœ‹èµ·æ¥èˆ’æœå¤šäº†ï¼Œå…¶æ¬¡å°±æ˜¯å¯ä»¥â€œè·Ÿâ€ä¸Šffmpegå¹³å‡ä¸¤å‘¨ä¸€æ›´çš„æ­¥ä¼ï¼ˆè¿™ç®—å¥½äº‹å§ï¼Ÿï¼‰</p>

<p>####Androidç‰ˆæœ¬ç¼–è¯‘
ç›´æ¥å‚è€ƒ<a href="http://www.roman10.net/how-to-build-ffmpeg-with-ndk-r9/">Romançš„æ–‡ç« </a>å³å¯ã€‚
NDK R10ç±»ä¼¼ã€‚</p>

<p>å½“ç„¶ä¹Ÿå¯ä»¥ç›´æ¥ç”¨è¿™ä¸ª<a href="http://chloette.github.io/ffmpeg4android/">ffmpeg4android@github</a>ï¼ˆä¹Ÿæ˜¯æˆ‘åœ¨ç»´æŠ¤ï¼‰</p>

<p>####FFmpegAdapter
æºç ä¸Šä¼ åˆ°<a href="http://chloette.github.io/FFmpegAdapter/">FFmpegAdapter@github</a>ï¼Œè‰è‰ä¸Šä¼ ï¼ˆç–æ¼ç”šå¤šï¼Œä»¥åä¼šå°½é‡ä¿æŒæ›´æ–°ï¼‰ã€‚</p>

<p>æœ€ç®€å•çš„ç”¨æ³•å°±æ˜¯ç›´æ¥inheritï¼Œè¿™æ ·load-libraryï¼Œjniæ¥å£æ˜ å°„ï¼ˆè¿™é‡Œä½¿ç”¨çš„æ˜¯ndké»˜è®¤æ˜ å°„æœºåˆ¶ï¼Œä¸æ˜¯manualé‚£å¥—ï¼‰ï¼Œerror-codeç­‰éƒ½ä¸éœ€è¦å•ç‹¬å†™ï¼Œè‡³å°‘æˆ‘æ˜¯è¿™ä¹ˆç›´æ¥ç”¨çš„ã€‚</p>

<p>ä¸»è¦ç›®çš„æ˜¯è§„é¿GPLå¼€æºé£é™©ï¼Œå‰¯äº§å“æ˜¯æ¸…æ™°äº†æ¡†æ¶ã€‚è¯•è¯•çœ‹å§ã€‚</p>

    </div>
    
      <div class="pagination">
        <div class="pagination__title">
          <span class="pagination__title-h">Read other posts</span>
          <hr />
        </div>
        <div class="pagination__buttons">
          
            <span class="button previous">
              <a href="/posts/android-docs-opengles/">
                <span class="button__icon">â†</span>
                <span class="button__text">Android docs (OpenGLES)</span>
              </a>
            </span>
          
          
            <span class="button next">
              <a href="/posts/astrill-vpn/">
                <span class="button__text">Astrill VPN</span>
                <span class="button__icon">â†’</span>
              </a>
            </span>
          
        </div>
      </div>
    

    

    </div>

      </div>

      
        <footer class="footer">
  <div class="footer__inner">
    
      <div class="copyright copyright--user">æ¥è‡ªæŸä¸ªå…«é›¶å</div>
    
  </div>
</footer>

<script src="/assets/main.js"></script>
<script src="/assets/prism.js"></script>


      
    </div>

    
  </body>
</html>
